name: Build Android APK (Template Injection Master)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # نثبت أحدث نسخة من Flet
      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # نستخدم Flutter 3.22 (الأحدث والأقوى)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Create Requirements File
        run: |
          echo "flet" > requirements.txt
          echo "certifi" >> requirements.txt
          echo "typing_extensions" >> requirements.txt
          echo "urllib3" >> requirements.txt
          echo "requests" >> requirements.txt
          echo "charset-normalizer" >> requirements.txt
          echo "idna" >> requirements.txt
          echo "openpyxl" >> requirements.txt

      - name: Prepare Icon
        run: |
          if [ -f "icon.png" ]; then
            echo "Icon found! ✅"
            mkdir -p assets
            cp icon.png assets/icon.png
          else
            echo "Warning: icon.png not found! Using default."
          fi

      - name: INJECT FIXES INTO FLUTTER TEMPLATES (The Master Key)
        shell: python
        run: |
          import os
          import shutil

          # 1. تحديد موقع قوالب Flutter في السيرفر
          flutter_bin = shutil.which("flutter")
          flutter_home = os.path.dirname(os.path.dirname(flutter_bin))
          print(f"Flutter Home: {flutter_home}")

          # البحث عن ملف قالب Manifest
          manifest_template = None
          for root, dirs, files in os.walk(flutter_home):
              for file in files:
                  if file == "AndroidManifest.xml.tmpl" and "android.tmpl" in root:
                      manifest_template = os.path.join(root, file)
                      break
              if manifest_template: break
          
          if not manifest_template:
              print("Error: Manifest template not found!")
              exit(1)

          print(f"Patching Manifest Template: {manifest_template}")

          with open(manifest_template, "r") as f:
              content = f.read()

          # --- التعديل 1: إضافة الأذونات (الحل الجذري للشاشة البيضاء) ---
          # نضيف إذن الإنترنت + Cleartext Traffic
          permissions_block = '''
          <uses-permission android:name="android.permission.INTERNET"/>
          <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
          '''
          
          if "android.permission.INTERNET" not in content:
              content = content.replace("<application", f"{permissions_block}\n    <application")
              print("Permissions Injected ✅")

          if 'android:usesCleartextTraffic="true"' not in content:
              content = content.replace("<application", '<application android:usesCleartextTraffic="true"')
              print("Cleartext Traffic Enabled ✅")

          # --- التعديل 2: تعطيل Impeller (ضمان إضافي) ---
          impeller_block = '        <meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />'
          if "EnableImpeller" not in content:
              content = content.replace("</application>", f"{impeller_block}\n    </application>")
              print("Impeller Disabled ✅")

          with open(manifest_template, "w") as f:
              f.write(content)

          # --- التعديل 3: تحديث SDK في قالب Gradle ---
          gradle_template = os.path.join(os.path.dirname(os.path.dirname(manifest_template)), "build.gradle")
          if not os.path.exists(gradle_template):
              # محاولة مسار بديل للقوالب الحديثة
              gradle_template = os.path.join(os.path.dirname(os.path.dirname(manifest_template)), "build.gradle.kts")

          if os.path.exists(gradle_template):
              print(f"Patching Gradle Template: {gradle_template}")
              with open(gradle_template, "r") as f:
                  g_content = f.read()
              
              import re
              # إجبار القالب على استخدام SDK 34 دائماً
              g_content = re.sub(r'compileSdkVersion .*', 'compileSdkVersion 34', g_content)
              g_content = re.sub(r'targetSdkVersion .*', 'targetSdkVersion 34', g_content)
              g_content = re.sub(r'compileSdk = .*', 'compileSdk = 34', g_content)
              g_content = re.sub(r'targetSdk = .*', 'targetSdk = 34', g_content)
              
              with open(gradle_template, "w") as f:
                  f.write(g_content)
              print("SDK Template Updated to 34 ✅")

      - name: Build APK (Auto Mode)
        # الآن نستخدم البناء التلقائي، وهو سيستخدم القوالب التي قمنا "بتهكيرها" للتو
        run: |
          flet build apk . --project StudentApp --product "المتابع المدرسي" --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          if [ -z "$APK_PATH" ]; then APK_PATH=$(find . -name "*.apk" | head -n 1); fi
          if [ -z "$APK_PATH" ]; then echo "Error: APK not found!"; exit 1; fi
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
