name: Build Android APK (Manual Nuclear Option)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # نثبت Flet فقط لتجهيز الأصول
      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # نستخدم Flutter 3.22 (القوي)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Prepare Project Workspace
        run: |
          # تنظيف أي محاولات سابقة
          rm -rf app_build
          mkdir app_build
          
          # نسخ ملفاتك
          cp main.py app_build/
          
          # إنشاء ملف المتطلبات
          echo "flet" > app_build/requirements.txt
          echo "openpyxl" >> app_build/requirements.txt
          
          # نسخ الأيقونة
          if [ -f "icon.png" ]; then
            cp icon.png app_build/
          fi

      - name: MANUALLY CREATE FLUTTER PROJECT
        run: |
          cd app_build
          
          # 1. إنشاء مشروع فارغ
          flutter create . --platforms android --org com.schoolapp --project-name student_app
          
          # 2. إضافة مكتبة Flet إلى Flutter (هذا ما كان ينقصنا!)
          flutter pub add flet
          
          # 3. حذف ملف main.dart الافتراضي
          rm lib/main.dart

      - name: PREPARE FLET ASSETS
        run: |
          cd app_build
          # هذا الأمر يضغط كود البايثون ويضعه في مجلد الأصول
          flet create . --description "المتابع المدرسي" --no-web --no-windows --no-linux --no-macos

      - name: WRITE MAIN.DART MANUALLY
        # نكتب كود التشغيل يدوياً لنضمن عمله
        run: |
          cd app_build/lib
          cat <<EOF > main.dart
          import 'package:flutter/material.dart';
          import 'package:flet/flet.dart';

          void main() async {
            await setupFlet();
            runApp(const FletApp());
          }
          EOF

      - name: INJECT MANIFEST FIXES (The Secret Sauce)
        shell: python
        run: |
          import os
          
          manifest_path = "app_build/android/app/src/main/AndroidManifest.xml"
          print(f"Patching: {manifest_path}")

          with open(manifest_path, "r") as f:
              content = f.read()

          # 1. أهم تعديل: السماح بالاتصال المحلي (Cleartext Traffic)
          # بدونه لن تعمل Flet أبداً على أندرويد الحديث
          if 'android:usesCleartextTraffic="true"' not in content:
              content = content.replace('<application', '<application android:usesCleartextTraffic="true"')
              print("Added: usesCleartextTraffic ✅")

          # 2. تعطيل Impeller (الشاشة البيضاء)
          impeller_fix = '        <meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />'
          if "EnableImpeller" not in content:
              content = content.replace('</application>', f'{impeller_fix}\n    </application>')
              print("Added: Disable Impeller ✅")

          # 3. الأذونات
          permissions = '''
          <uses-permission android:name="android.permission.INTERNET"/>
          <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
          '''
          if "android.permission.INTERNET" not in content:
              content = content.replace('<application', f'{permissions}\n    <application')
              print("Added: Permissions ✅")

          # 4. الاسم العربي
          content = content.replace('android:label="student_app"', 'android:label="الرفيق المدرسي"')

          with open(manifest_path, "w") as f:
              f.write(content)

      - name: FIX GRADLE SDK VERSION
        run: |
          cd app_build/android/app
          # نحدث SDK إلى 34
          sed -i 's/compileSdk = .*/compileSdk = 34/g' build.gradle
          sed -i 's/targetSdk = .*/targetSdk = 34/g' build.gradle
          # احتياطاً للنسخ القديمة
          sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' build.gradle
          sed -i 's/targetSdkVersion .*/targetSdkVersion 34/g' build.gradle

      - name: BUILD APK
        run: |
          cd app_build
          flutter build apk --release --target-platform android-arm,android-arm64

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: app_build/build/app/outputs/flutter-apk/app-release.apk
