name: Build Android APK (Template Injection Fix)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Flet
      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Ù†Ø³ØªØ®Ø¯Ù… Flutter 3.22.0 (Ø­Ø¯ÙŠØ« ÙˆÙ…Ø³ØªÙ‚Ø±)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Create Requirements File
        run: |
          echo "flet" > requirements.txt
          echo "certifi" >> requirements.txt
          echo "typing_extensions" >> requirements.txt
          echo "urllib3" >> requirements.txt
          echo "requests" >> requirements.txt
          echo "charset-normalizer" >> requirements.txt
          echo "idna" >> requirements.txt
          echo "openpyxl" >> requirements.txt

      - name: Prepare Icon
        run: |
          if [ -f "icon.png" ]; then
            echo "Icon found! âœ…"
            mkdir -p assets
            cp icon.png assets/icon.png
          else
            echo "Warning: icon.png not found! Using default."
          fi

      - name: INJECT IMPELLER DISABLE INTO FLUTTER (The Magic Trick)
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù…Ù„Ù AndroidManifest Ø¯Ø§Ø®Ù„ Flutter
        # ÙˆØªØ¶ÙŠÙ Ø¥Ù„ÙŠÙ‡ ÙƒÙˆØ¯ ØªØ¹Ø·ÙŠÙ„ Impeller Ù‚Ø¨Ù„ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: |
          FLUTTER_HOME=$(dirname $(dirname $(which flutter)))
          echo "Flutter located at: $FLUTTER_HOME"
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù€ Manifest
          # Ù†Ø³ØªØ®Ø¯Ù… find Ù„Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ù‚Ø¯ ÙŠØ®ØªÙ„Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹
          TEMPLATE_FILE=$(find $FLUTTER_HOME -name "AndroidManifest.xml.tmpl" | grep "android.tmpl" | head -n 1)
          
          if [ -z "$TEMPLATE_FILE" ]; then
             echo "Could not find AndroidManifest template! Trying generic search..."
             TEMPLATE_FILE=$(find $FLUTTER_HOME -name "AndroidManifest.xml" | grep "templates" | head -n 1)
          fi

          if [ -z "$TEMPLATE_FILE" ]; then
             echo "Error: Critical template file not found. Skipping injection (Fix might fail)."
          else
             echo "Injecting fix into: $TEMPLATE_FILE"
             
             # Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ø¥Ø¶Ø§ÙØ© meta-data Ù„ØªØ¹Ø·ÙŠÙ„ Impeller
             # Ù†Ù‚ÙˆÙ… Ø¨Ø­Ù‚Ù† Ø§Ù„Ø³Ø·Ø± Ù‚Ø¨Ù„ ÙˆØ³Ù… Ø¥ØºÙ„Ø§Ù‚ </application>
             sed -i 's|</application>|        <meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />\n    </application>|g' "$TEMPLATE_FILE"
             
             echo "Injection Successful! Impeller will be disabled by default. ğŸ’‰âœ…"
             cat "$TEMPLATE_FILE" | grep "EnableImpeller"
          fi

      - name: Build APK (Auto Mode)
        # Ø§Ù„Ø¢Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø£Ø¹Ù„Ø§Ù‡
        run: |
          flet build apk . --project StudentApp --product "Ø§Ù„Ù…ØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ" --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find . -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "Error: APK file not found!"
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
