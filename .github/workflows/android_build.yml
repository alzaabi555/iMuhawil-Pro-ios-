name: Build Android APK (Root Template Hack)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # نستخدم Flutter 3.22 (الأحدث)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Create Requirements
        run: |
          echo "flet" > requirements.txt
          echo "openpyxl" >> requirements.txt

      - name: Prepare Icon
        run: |
          if [ -f "icon.png" ]; then
            echo "Icon found! ✅"
            mkdir -p assets
            cp icon.png assets/icon.png
          fi

      - name: HACK FLUTTER TEMPLATES (The God Mode Fix)
        shell: python
        run: |
          import os
          import shutil

          # 1. تحديد مكان Flutter في السيرفر
          flutter_bin = shutil.which("flutter")
          flutter_home = os.path.dirname(os.path.dirname(flutter_bin))
          print(f"Flutter Home: {flutter_home}")

          # 2. البحث عن القالب الأصلي (AndroidManifest.xml.tmpl)
          # هذا الملف هو "الأم" التي يولد منها Flutter كل المشاريع
          template_path = None
          for root, dirs, files in os.walk(flutter_home):
              for file in files:
                  if file == "AndroidManifest.xml.tmpl" and "app/src/main" in root:
                      template_path = os.path.join(root, file)
                      break
              if template_path: break

          if not template_path:
              print("Error: Could not find Flutter templates! Trying fallback search...")
              for root, dirs, files in os.walk(flutter_home):
                  if file == "AndroidManifest.xml.tmpl":
                       template_path = os.path.join(root, file)
                       break
          
          if not template_path:
              print("FATAL: Template not found. Script cannot continue.")
              exit(1)

          print(f"Hacking Template at: {template_path}")

          with open(template_path, "r") as f:
              content = f.read()

          # --- التعديل 1: السماح بالاتصال المحلي (Cleartext) ---
          # هذا هو السبب رقم 1 للشاشة البيضاء في تطبيقات Flet
          if 'android:usesCleartextTraffic="true"' not in content:
              content = content.replace('<application', '<application android:usesCleartextTraffic="true"')
              print("Fix 1: Cleartext Traffic Enabled (In Template) ✅")

          # --- التعديل 2: إضافة أذونات الإنترنت ---
          permissions = '''
          <uses-permission android:name="android.permission.INTERNET"/>
          <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
          '''
          if "android.permission.INTERNET" not in content:
              content = content.replace("<application", f"{permissions}\n    <application")
              print("Fix 2: Permissions Injected (In Template) ✅")

          # --- التعديل 3: تعطيل Impeller ---
          impeller_fix = '        <meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />'
          if "EnableImpeller" not in content:
              content = content.replace("</application>", f"{impeller_fix}\n    </application>")
              print("Fix 3: Impeller Disabled (In Template) ✅")

          # حفظ التعديلات في القالب الأم
          with open(template_path, "w") as f:
              f.write(content)

          # --- التعديل 4: إجبار Gradle على SDK 34 ---
          # نبحث عن قالب build.gradle.kts.tmpl أو build.gradle.tmpl
          gradle_template = None
          for root, dirs, files in os.walk(flutter_home):
               if "build.gradle" in files or "build.gradle.kts.tmpl" in files:
                   # بحث عن ملفات القوالب التي تحتوي على compileSdkVersion
                   for f_name in files:
                       if "gradle" in f_name:
                           path = os.path.join(root, f_name)
                           with open(path, 'r') as f:
                               if "compileSdkVersion" in f.read() or "compileSdk" in f.read():
                                   gradle_template = path
                                   break
               if gradle_template: break
          
          if gradle_template:
              print(f"Hacking Gradle Template at: {gradle_template}")
              with open(gradle_template, "r") as f:
                  g_content = f.read()
              
              import re
              g_content = re.sub(r'compileSdkVersion .*', 'compileSdkVersion 34', g_content)
              g_content = re.sub(r'targetSdkVersion .*', 'targetSdkVersion 34', g_content)
              g_content = re.sub(r'compileSdk = .*', 'compileSdk = 34', g_content)
              g_content = re.sub(r'targetSdk = .*', 'targetSdk = 34', g_content)

              with open(gradle_template, "w") as f:
                  f.write(g_content)
              print("Fix 4: SDK Forced to 34 (In Template) ✅")

      - name: Build APK (Auto Mode)
        # الآن نستخدم البناء التلقائي، وسوف يرث التطبيق كل الإصلاحات من القالب المعدل
        run: |
          flet build apk . --project StudentApp --product "المتابع المدرسي" --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          if [ -z "$APK_PATH" ]; then APK_PATH=$(find . -name "*.apk" | head -n 1); fi
          if [ -z "$APK_PATH" ]; then echo "Error: APK not found!"; exit 1; fi
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
